# SPDX-License-Identifier: MIT
# (C) 2023 The Asahi Linux Contributors

context.properties = {
    log.level = 0
    default.clock.rate = 96000
    default.clock.allowed-rates = [ 44100 48000 96000 192000 ]
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.*       = support/libspa-support
}


context.modules = [
    { name = libpipewire-module-rt
        args = {
            nice.level    = -11
            rt.prio       = 88
            #rt.time.soft = -1
            #rt.time.hard = -1
        }
        flags = [ ifexists nofail ]
    }
    { name = libpipewire-module-filter-chain
        args = {
            node.description = "Mac mini Speaker"
            media.name       = "Mac mini Speaker"
            filter.graph = {
                nodes = [

                    # Left
                    {
                        type = builtin
                        label = convolver
                        name = convL
                        config = {
                            filename = [
                                "/usr/share/pipewire/devices/apple/mini/441.wav"
                                "/usr/share/pipewire/devices/apple/mini/48.wav"
                                "/usr/share/pipewire/devices/apple/mini/96.wav"
                                "/usr/share/pipewire/devices/apple/mini/192.wav"
                            ]
                            channel = 0
                        }
                    }

                    # Right
                    {
                        type = builtin
                        label = convolver
                        name = convR
                        config = {
                            filename = [
                                "/usr/share/pipewire/devices/apple/mini/441.wav"
                                "/usr/share/pipewire/devices/apple/mini/48.wav"
                                "/usr/share/pipewire/devices/apple/mini/96.wav"
                                "/usr/share/pipewire/devices/apple/mini/192.wav"
                            ]
                            channel = 0
                        }
                    }

                    {
                        type = builtin
                        label = mixer
                        name = mix
                        control = { "Gain 1" = "0.5" "Gain 2" = 0.5" }
                    }
                # Route the inputs to their appropriate convolvers
                links = [ { output = "convL:Out" input = "mix:In 1" }
                          { output = "convR:Out" input = "mix:In 2" } ]
                inputs = [ "convL:In" "convR:In" ]
                outputs = [ "mix:Out" ]
            }
            capture.props = {
                node.name = "audio_input.mini-convolver"
                media.class = Audio/Sink
                audio.channels = 2
                audio.position = [ FL FR ]
            }

            playback.props = {
                node.target = "alsa_output.platform-sound.pro-output-1"
                node.passive = true
                audio.channels = 1
                audio.position = [ AUX0 ]
            }
        }
    }
]
