# SPDX-License-Identifier: MIT
# (C) 2022 The Asahi Linux Contributors

context.properties = {
    log.level = 3
    default.clock.rate = 96000
    default.clock.allowed-rates = [ 44100 48000 96000 192000 ]
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.*       = support/libspa-support
}


context.modules = [
    { name = libpipewire-module-rt
        args = {
            nice.level    = -11
            rt.prio       = 88
            #rt.time.soft = -1
            #rt.time.hard = -1
        }
        flags = [ ifexists nofail ]
    }
    { name = libpipewire-module-filter-chain
        args = {
            node.description = "MacBook Pro J31x Speakers"
            media.name       = "MacBook Pro J31x Speakers"
            filter.graph = {
                nodes = [

                    {
                        type = lv2
                        plugin = "http://lsp-plug.in/plugins/lv2/mb_compressor_stereo"
                        name = compressor
                        control = {
                            # Enable
                            mode = 1
                            bypass = 0

                            # Preamp volumes
                            g_in = 1
                            g_out = 1
                            g_dry = 0
                            g_wet = 1

                            bsel = 0
                            flt = 1
                            ife_l = 0
                            ofe_l = 0
                            ife_r = 0
                            ofe_r = 0

                            # Band 0
                            cbe_0 = 1
                            ce_0 = 1
                            al_0 = 0.17
                            at_0 = 0
                            rrl_0 = 0
                            rt_0 = 750
                            cr_0 = 4.75
                            kn_0 = 0.251197
                            sla_0 = 10.0


                            # Band 1
                            cbe_1 = 1
                            ce_1 = 1
                            sf_1 = 160
                            al_1 = 0.15
                            at_1 = 0
                            rrl_1 = 0
                            rt_1 = 750
                            cr_1 = 4.75
                            kn_1 = 0.20
                            sla_1 = 10.0

                            # Band 2
                            cbe_2 = 1
                            sf_2 = 400
                            ce_2 = 0
                            sla_2 = 10.0

                            # Band 7
                            cbe_7 = 1
                            sf_7 = 2000
                            ce_7 = 1
                            al_7 = 0.5
                            at_7 = 0
                            rrl_7 = 750
                            cr_7 = 2.5
                            kn_7 = 0.251197
                            sla_7 = 10.0

                            # Disable other bands
                            cbe_3 = 0
                            cbe_4 = 0
                            cbe_5 = 0
                            cbe_6 = 0
                            bs_0 = 0
                            bm_0 = 0
                        }
                    }


                    #{ type = builtin label = copy name = copyL }
                    #{ type = builtin label = copy name = copyR }
                    # Left Tweeter
                    {
                        type = builtin
                        label = convolver
                        name = convLT
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/j314/tweeters2.wav"
                            filenames = [
                                "/usr/share/pipewire/devices/apple/j314/tweeters-441.wav"
                                "/usr/share/pipewire/devices/apple/j314/tweeters-48.wav"
                                "/usr/share/pipewire/devices/apple/j314/tweeters-96.wav"
                                "/usr/share/pipewire/devices/apple/j314/tweeters-192.wav"
                            ]
                            channel = 0
                        }
                    }

                    # Right Tweeter
                    {
                        type = builtin
                        label = convolver
                        name = convRT
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/j314/tweeters2.wav"
                            filenames = [
                                "/usr/share/pipewire/devices/apple/j314/tweeters-441.wav"
                                "/usr/share/pipewire/devices/apple/j314/tweeters-48.wav"
                                "/usr/share/pipewire/devices/apple/j314/tweeters-96.wav"
                                "/usr/share/pipewire/devices/apple/j314/tweeters-192.wav"
                            ]
                            channel = 0
                        }
                    }

                    # Left Woofer
                    {
                        type = builtin
                        label = convolver
                        name = convLW
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/j314/woofers2.wav"
                            filenames = [
                                "/usr/share/pipewire/devices/apple/j314/woofers-441.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-48.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-96.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-192.wav"
                            ]
                            channel = 0
                        }
                    }

                    # Right Woofer
                    {
                        type = builtin
                        label = convolver
                        name = convRW
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/j314/woofers2.wav"
                            filenames = [
                                "/usr/share/pipewire/devices/apple/j314/woofers-441.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-48.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-96.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-192.wav"
                            ]
                            channel = 0
                        }
                    }

                    # Left Subwoofer
                    {
                        type = builtin
                        label = convolver
                        name = convLW2
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/j314/woofers2.wav"
                            filenames = [
                                "/usr/share/pipewire/devices/apple/j314/woofers-441.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-48.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-96.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-192.wav"
                            ]
                            channel = 0
                        }
                    }

                    # Right Subwoofer
                    {
                        type = builtin
                        label = convolver
                        name = convRW2
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/j314/woofers2.wav"
                            filenames = [
                                "/usr/share/pipewire/devices/apple/j314/woofers-441.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-48.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-96.wav"
                                "/usr/share/pipewire/devices/apple/j314/woofers-192.wav"
                            ]
                            channel = 0
                        }
                    }
                ]

                # Map the inputs to their appropriate convolvers
                links = [
                    { output = "compressor:out_l" input = "convLT:In"}
                    { output = "compressor:out_l" input = "convLW:In"}
                    { output = "compressor:out_l" input = "convLW2:In"}
                    { output = "compressor:out_r" input = "convRT:In"}
                    { output = "compressor:out_r" input = "convRW:In"}
                    { output = "compressor:out_r" input = "convRW2:In"}


                ]

                inputs = [ "compressor:in_l" "compressor:in_r" ]
                outputs = [ "convLW:Out"
                            "convRW:Out"
                            "convLT:Out"
                            "convRT:Out"
                            "convLW2:Out"
                            "convRW2:Out"
                            ]
            }
            capture.props = {
                node.name = "audio_input.j31x-convolver"
                media.class = Audio/Sink
                audio.channels = 2
                audio.position = [ FL FR ]
            }

            playback.props = {
                node.target = "alsa_output.platform-sound.pro-output-1"
                node.passive = true
                audio.channels = 6
                audio.position = [ AUX0 AUX1 AUX2 AUX3 AUX4 AUX5 ]
            }
        }
    }
]
